---
title: 在Beisen做Account
layout: post
guid: b135efec-4df6-11e7-8e5d-60d819d353ad
tags:
  - Notes

---

最近半年几乎都在忙一件事，Beisen新的用户账户体系。不过话说回来，跟我没啥关系，我只是一个距离最近的局外人，视角可能非常独特，身在其中，却又游离在这之外

北森目前有两套用户账户体系并存，可能在未来的一两个月内会完成用户账户体系的替换

其中一套是最早能追溯到2012年（至少从代码层面可以追溯到2012年，可能更早）的一套名叫BeisenUser的用户体系，这套体系延续至今已经非常非常庞大，涵盖了不止是用户账户体系的东西，比如早期的产品授权、产品许可、用户授权、用户许可、租户级的一些权限控制和信息检索都在其中，其中许可证复杂到目前没有一个开发能全部吃透，处于一种「这套代码能正常运行、但是一旦随便改一点什么东西都会出现若干不可知问题」的状态

这套代码的维护也是经过层层转手，在我摸到这套代码的时候，它的维护者是鹏哥，在鹏哥的帮助下我还曾经改过一些BeisenUser的代码，但基本都是小改，根本没人改大改

在去年九月份左右卢杰从薪酬回到我们组，不知道是接着当我们组的老大、还是成为我们组的老大，反正就这么开始准备折腾BeisenUser了

当时的情况是，招聘、测评作为北森最赚钱的两个业务，对用户账户体系确实也有很多新需求，但BeisenUser一方面是不方便改动来增加新功能，另一方面是没人敢动，处于几乎就要维护不下去的状态。我不知道经过怎样的纠缠之后，老王作为前PPS的老大，主管的业务被砍到只剩下我们组，于是在大概10月份确定下来要做一套新的BeisenUser替换掉曾经的BeisenUser，新的BeisenUser的Code Name叫UserFramework，民间昵称Account，正式对外名字叫系统管理（这命名真的很垃圾，因为以前的集中授权站点就叫系统管理）

当时我们组的情况并没有想象的那么乐观，除了要做新的Account，还要维护的内容包括以下一些：

+ TMS首页（TMS平台所有产品入口）
+ TMS设置（TMS平台的租户级管理站点，包括用户管理、授权管理、操作日志、胜任力、森豆等等诸多乱七八糟的东西）、
+ 系统管理（Code Name SystemManage，整个北森集中授权站点）
+ 支持系统（主要是给客服使用的管理全租户产品开通、管理员授权等等重要操作的站点）
+ 旧BeisenUser
+ 权限ESB（系统管理站点的ESB版本，对外提供一些接口满足其他团队的开发授权需求）
+ BeisenUserExternal ESB（对外提供BeisenUser的一些功能，旧BeisenUser是SDK形式对外发布）

上面罗列的所有站点和ESB都没有单元测试，也没有CI支持，更没有完善的日志记录，上线全凭运气和测试随便点一点，每次遇到客服事物都需要花费大量的时间去追查问题所在和修复问题，修复的时候也需要非常小心，因为代码太老，跟贝尔不知道改了一处之后是否对其他地方有重大影响，也不知道测试到底能否覆盖完全

当时我们组的人员配置是，加上我在内，一共有5个开发，其中组长有接近10年工作经验，一个主力开发有3年经验，另一个转正刚半年，还有两个实习生。

当时我明确跟卢杰表达过我想跟着一起写新的Account的愿望，可是被驳回了，原因是卢杰觉得我做了比较长时间的权限，比较熟悉，于是让我一个人扛系统管理，我也没什么办法于是就接受了。最惨的一段时间，大概是11月到1月份之间，我几乎把上面罗列的4个站点全管了，在我忙不过来的时候他们4个人会过来帮我一下

接下来就是从2017年1月份开始，我主要精力都放在维护和重构系统管理、权限ESB上，也就是说，我一个人在处理整个北森的权限管理体系。这期间我修复了若干bug，重构了系统管理的一部分逻辑，把整个产品列表从硬编码改到了读远程配置。最显著的后果就是，曾经如果需要新增一个产品到系统管理里面进行授权，需要配合修改系统管理的若干处代码，而现在只需要修改一个远程配置

同时我把系统管理整理到了一种能给别人讲清楚的程度

但是远远不够，到现在为止，系统管理还存在着非常多的bug，每次有人修改之后都会引入新的bug，原因很简单，逻辑太乱整理的程度不够，重构的程度也不够，还缺乏有效的单元测试导致每次修改代码都在赌运气

2、3月份随着tita团队开始接入Account，需要使用权限ESB的接口进行授权，但是权限ESB还欠缺一大堆接口，在匆匆忙忙之间，tita的开发来找我要接口，我没怎么问清楚、也没怎么想清楚，就提供了一些非常要命的接口，比如给租户开产品、开许可证、给人授权某个产品的权限之类的。结果有个接口我自己都没怎么测试、tita的开发也没怎么测试，就跑了全租户的数据，导致丢失了1000多条租户管理员的权限数据，我和老王通宵了一周，在招聘老大徐东的帮助下才修复

这差不多是我在北森能犯的最大的错误了，结果也非常要命，从老王的语气上看，似乎这次错误在某种程度上断送了他在北森的八年工作。我也觉得挺冤枉的，那段时间我连测试都分不到，也没有人review我的代码，哪怕我找到zzz和卢杰让他们看一眼，他们也只是随便过一下就算了，因为大家事情都很多，也没有啥心情帮我review代码

事情就这么乱了，然后又被修了回来，那时候三月基本就过完了，而我连自己的论文都没有时间改，毕业也拖到了6月

4月我请了一个月的假，好好修改了一下自己的毕业论文，然后顺利毕业

5月又是忙到爆炸的一个月。按照计划，6月份全租户都要使用Account管理用户账户和授权，所以权限数据需要迁移，原计划这个迁移工具是3月份做好开始处理数据，但是3月明显没搞完，4月我不在的时候这个工具居然几乎一点都没动，5月我又花了整整一个月完善和测试这个工具，最后在昨天全部跑完了这3000多家还在使用北森产品的租户

与此同时卢杰带着Account组在做什么呢？在我把权限搞坏的那一周的周一，他做了一个分布式锁导致tita半天无法登录，接下来那周昏天黑地地修了一周bug，进入4月之后，据说也是黑暗的一两周。5月份我回归之后感觉他们还挺轻松的，每天我基本都是最后走的，翔哥和zzz甚至还经常7点钟就准时下班了

进入6月之后似乎大家都更加轻松了，他们甚至还有了一些余裕来帮我修一些系统管理的bug，大家也基本都能勉强按时下班

Account似乎终于稳定下来了

这半年差不多也就这么过完了

可是BeisenUser还是没能完全被替换掉，因为租户级的很多东西还是需要的，而UserFramework基本没有提供租户级的接口，路还很长

这半年其实我觉得我过得挺憋屈的，特别是昨天跟我谈Offer的时候老王说的话，让我觉得非常不满。老王只给了我9.5k的工资，压低工资的理由是我3月份那次权限丢失的事故。怎么说呢，我觉得这个锅我背得很冤枉，首先那次新的接口需求，是两个开发商量出来的，产品经理既没有过问也没有设计，最后接口写出来之后也没有时间和资源测试，我自己随便跑了跑就交出去了，最后出了问题全是我背锅，我心里服气吗？完全不服气，特别是老王还说了一句，你看同样是实习生的常续就没有出问题。要是我每次签入代码的时候稍微有卢杰给review一下代码，平时工作有个同事能跟我讨论一下，测试资源能稍微分我一点点，我觉得我也不会出这么大的问题。我承担了最大的责任，虽然出了问题但最后也算是圆满完成了任务，还是要背最大的锅，拿最低的工资，我觉得很心寒。

特别是我接下了所有人都不愿意做、甚至连看都不愿意看的工作，不仅没有任何奖励，还全是指责，我觉得我忍到现在真的是全靠我素养好，还有一点是现在没有能力走。所以现在哪怕熬夜我都在保证每天推进自己的补习计划，先在这里活两个月，能走的时候立马就走了

团队管理并不是通过领导都是半夜走、24小时在线回邮件回QQ做到的，光是画饼说你前几年要努力积累经验和能力但是工作中完全不给任何喘息的机会，我并不认同这种管理

人心，人心才是一切的关键，有人不懂人心